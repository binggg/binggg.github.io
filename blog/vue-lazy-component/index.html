<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/gatsby-contentful-starter/component---src-layouts-index-js-08ee7e55993cdf4c75cc.js" as="script"/><link rel="preload" href="/gatsby-contentful-starter/component---src-templates-blog-post-js-54ed0a12f5ff671a4ad0.js" as="script"/><link rel="preload" href="/gatsby-contentful-starter/path---blog-vue-lazy-component-63a3a39ab733be5d2f50.js" as="script"/><link rel="preload" href="/gatsby-contentful-starter/app-6a6137d1e4f479833e32.js" as="script"/><link rel="preload" href="/gatsby-contentful-starter/commons-ba4cb63d6a7a0250cd9f.js" as="script"/><title data-react-helmet="true">性能优化之组件懒加载: Vue Lazy Component 介绍 | undefined</title><style id="gatsby-inlined-css">@font-face{font-family:Avenir;font-weight:400;font-style:normal;src:url("/avenir-400.woff2") format("woff2");font-display:swap}body{font-family:Avenir,Tahoma,Arial,Helvetica,sans-serif;font-size:1em;line-height:1.65;color:#373f49;background:#eee;margin:0}img{display:block;width:100%}h1,h2,h3{font-size:2em;font-weight:400}a{color:currentColor}.wrapper{width:calc(100% - 10vmin);margin:0 auto;padding:5vmin 0}.article-list{margin:0;padding:0;list-style:none;display:-ms-grid;display:grid;-ms-grid-columns:(minmax(200px,1fr))[auto-fit];grid-template-columns:repeat(auto-fit,minmax(200px,1fr));grid-gap:5vmin}.section-headline{padding:0 0 .4em;margin:0 0 5vmin;border-bottom:1px solid #ddd}.list-inline{margin:0;padding:0;list-style:none}.list-inline li{display:inline-block}.src-components----navigation-module---navigation---_yI7y{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;list-style:none;padding:0;margin:0;height:20vh;max-height:100px;font-size:1.25em}.src-components----navigation-module---navigationItem---1plNx{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;margin:0 1em}.src-components----navigation-module---navigationItem---1plNx a{color:currentColor}.src-components----hero-module---hero---S__gH{position:relative;background:#000;color:#fff;text-align:center}.src-components----hero-module---heroImage---DciWV{height:61.8vh;max-height:400px}.src-components----hero-module---heroDetails---3uv8x{position:absolute;background:rgba(0,0,0,.7);left:50%;bottom:0;-ms-transform:translate(-50%);transform:translate(-50%);font-size:14px;padding:0 .5em}@media(min-width:600px){.src-components----hero-module---heroDetails---3uv8x{font-size:16px}}@media(min-width:1000px){.src-components----hero-module---heroDetails---3uv8x{font-size:20px}}.src-components----hero-module---heroHeadline---jhgHQ{margin:0}.src-components----hero-module---heroTitle---2LulU{margin:0;font-size:1.125em;font-weight:700}.src-pages----blog-module---hero---TCejO{display:-ms-flexbox;display:flex;-ms-flex-pack:center;justify-content:center;-ms-flex-align:center;align-items:center;height:61.8vh;max-height:400px;background:#e1e1e1;font-size:2em;overflow:hidden}.src-components----article-preview-module---previewTitle---16pYm{font-size:1.5em}.src-components----article-preview-module---tag---27JAs{color:#a0a0a0;text-decoration:none;display:inline-block;padding:.33333rem .5rem;line-height:1;border-radius:2px;border:1px solid #a0a0a0;margin-right:.5em}</style></head><body><div id="___gatsby"><div style="max-width:1180px;margin:0 auto;" data-reactroot="" data-reactid="1" data-react-checksum="-1375434184"><nav role="navigation" data-reactid="2"><ul class="src-components----navigation-module---navigation---_yI7y" data-reactid="3"><li class="src-components----navigation-module---navigationItem---1plNx" data-reactid="4"><a href="/gatsby-contentful-starter/" data-reactid="5">Home</a></li><li class="src-components----navigation-module---navigationItem---1plNx" data-reactid="6"><a href="/gatsby-contentful-starter/blog/" data-reactid="7">Blog</a></li></ul></nav><div style="background:#fff;" data-reactid="8"><!-- react-empty: 9 --><div class="src-components----hero-module---hero---S__gH" data-reactid="10"><div class=" gatsby-image-outer-wrapper" style="position:relative;" data-reactid="11"><div class="src-components----hero-module---heroImage---DciWV gatsby-image-wrapper" style="position:relative;overflow:hidden;" data-reactid="12"><div style="width:100%;padding-bottom:55.941023417172595%;" data-reactid="13"></div><img alt="性能优化之组件懒加载: Vue Lazy Component 介绍" src="data:image/jpeg;base64,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" style="position:absolute;top:0;left:0;transition:opacity 0.5s;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:0.25s;" data-reactid="14"/><noscript data-reactid="15"><img src="//images.ctfassets.net/9ys45gwh7pzh/4NzwDSDlGECGIiokKomsyI/7afbb1e104cb9db273f282a023e4446a/2053ec7627435298b0a1470a2beaeea6.png?w=1180&q=50&bg=rgb%3A000000" srcset="//images.ctfassets.net/9ys45gwh7pzh/4NzwDSDlGECGIiokKomsyI/7afbb1e104cb9db273f282a023e4446a/2053ec7627435298b0a1470a2beaeea6.png?w=295&h=165&q=50&bg=rgb%3A000000 295w,
//images.ctfassets.net/9ys45gwh7pzh/4NzwDSDlGECGIiokKomsyI/7afbb1e104cb9db273f282a023e4446a/2053ec7627435298b0a1470a2beaeea6.png?w=590&h=330&q=50&bg=rgb%3A000000 590w,
//images.ctfassets.net/9ys45gwh7pzh/4NzwDSDlGECGIiokKomsyI/7afbb1e104cb9db273f282a023e4446a/2053ec7627435298b0a1470a2beaeea6.png?w=1180&h=660&q=50&bg=rgb%3A000000 1180w,
//images.ctfassets.net/9ys45gwh7pzh/4NzwDSDlGECGIiokKomsyI/7afbb1e104cb9db273f282a023e4446a/2053ec7627435298b0a1470a2beaeea6.png?w=1770&h=990&q=50&bg=rgb%3A000000 1770w,
//images.ctfassets.net/9ys45gwh7pzh/4NzwDSDlGECGIiokKomsyI/7afbb1e104cb9db273f282a023e4446a/2053ec7627435298b0a1470a2beaeea6.png?w=2306&h=1290&q=50&bg=rgb%3A000000 2306w" alt="性能优化之组件懒加载: Vue Lazy Component 介绍" sizes="(max-width: 1180px) 100vw, 1180px" style="position:absolute;top:0;left:0;transition:opacity 0.5s;transition-delay:0.5s;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></noscript></div></div></div><div class="wrapper" data-reactid="16"><h1 class="section-headline" data-reactid="17">性能优化之组件懒加载: Vue Lazy Component 介绍</h1><p style="display:block;" data-reactid="18">May 15th, 2017</p><div data-reactid="19"><h1>性能优化之组件懒加载: Vue Lazy Component 介绍</h1>
<p><a name="gne4ik"></a></p>
<h2><a href="#gne4ik"></a>初始加载资源过多</h2>
<p>问题起源于我们的一个页面，下面是这个页面的截图和初次请求的瀑布图。<br /><img src="http://upload-images.jianshu.io/upload_images/64173-93b7be468b4a447a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>初始加载的时候，一共请求了 155 个资源，请求的瀑布图就快要和页面一样长了 😊</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-a95789d2d7510c49.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>初始加载的资源过多导致在 domInteractive 之后，页面花费了大量时间加载子资源，导致页面的 load 时长被严重拖长，达到了 5.6s 。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-2cdf5edfed3b213b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>来看看这些子资源都是什么，根据请求资源的类型，我们找到了最多的类型是图片，这是显而易见的，页面上到处都是大图片，其次是 js 文件，由第三方的业务插件和一些 JSONP 的接口组成。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-a78a94cd3cff5d96.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p><a name="sb2gwg"></a></p>
<h2><a href="#sb2gwg"></a>问题分析</h2>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-05774966a43c531b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>再回到最初的这个页面，结合上面的数据情况我们得出了这个页面的问题总结结论：</p>
<ul>
<li>
<p>页面由大量模块组成</p>
</li>
<li>
<p>每个模块部分由首页自主维护，部分由业务方通过插件维护</p>
</li>
<li>
<p>所有模块是同时进行加载</p>
</li>
<li>
<p>模块中图片内容较多</p>
</li>
<li>
<p>每个模块的依赖资源较多（包括 js 文件、接口文件、css 文件等）</p>
</li>
</ul>
<p><a name="a2u1dv"></a></p>
<h2><a href="#a2u1dv"></a>解决思路</h2>
<p>我们提出了下面两个主要的解决思路：</p>
<p><a name="u90uvh"></a></p>
<h3><a href="#u90uvh"></a>组件化分治思想</h3>
<p>为了方便后续的优化，我们必须要求每个模块之间降低耦合，将相关的逻辑（比如请求接口、请求相关的依赖资源）都封装在内部，在 Vue 里落实成组件的形式。</p>
<ul>
<li>
<p>将各模块拆分为组件粒度</p>
</li>
<li>
<p>将组件依赖的资源全部封装在组件内部进行调用</p>
</li>
</ul>
<p><a name="dl4nnl"></a></p>
<h3><a href="#dl4nnl"></a>加载优先级</h3>
<p>在完成了组件化的拆分，确保模块之间不会互相影响和产生耦合之后，我们可以方面地调整加载策略。加载的策略是根据可见性来处理优先级问题。</p>
<ul>
<li>
<p>优先加载首屏可见模块</p>
</li>
<li>
<p>其余不可见模块懒加载，待可见或即将可见时加载</p>
</li>
</ul>
<p>有了上面的解决思路，我们开始思考具体的实现：</p>
<p><a name="4d5gsv"></a></p>
<h3><a href="#4d5gsv"></a>如何解决判断可见性问题？</h3>
<p>从前我们都是通过监听滚动事件、resize 事件来判断模块是否可见，代码不仅繁琐，而且一不小心没有函数去抖就又可能导致严重的性能问题。</p>
<p>现在我们有了更好的选择—— IntersectionObserver API ，IntersectionObserver 允许你配置一个回调函数，每当 target ，元素和设备视口或者其他指定元素发生交集的时候该回调函数将会被执行。这个 API 的设计是异步的，而且保证你的回调执行次数是非常有限的，而且回调是会在主线程空闲时才执行，在性能方面表现更优，使用起来也更简单。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-7fd2265c79976d77.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>目前是现代浏览器支持，低版本浏览器可以通过 polyfill 兼容。</p>
<p><a name="8901oc"></a></p>
<h3><a href="#8901oc"></a>如何尽可能懒的条件渲染？</h3>
<p>在解决了加载条件的判断之后，我们需要解决加载条件为假的情况下不去渲染、加载条件为真的时候才渲染的问题，这里的答案非常简单：使用 Vue.js 提供的 v-if 指令，就可以做到真正的惰性渲染。</p>
<p><a name="u1uufn"></a></p>
<h3><a href="#u1uufn"></a>如果可见后进行初始渲染，可见前如何显示？</h3>
<p>如果在判断加载条件为假的时候，什么都不渲染，就会带来一系列问题：</p>
<ul>
<li>
<p>用户体验比较差，最开始是白屏，然后突然又渲染出现内容。</p>
</li>
<li>
<p>最致命的是我们判断可见性是需要一个目标来观察的，如果什么不都渲染，我们就无从观察。</p>
</li>
</ul>
<p>这里引入一个骨架屏的概念，我们为真实的组件做一个在尺寸、样式上非常接近真实组件的组件，叫做骨架屏。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-b6fc1e2ca2f30938.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>骨架屏的作用有：</p>
<ul>
<li>
<p>提升用户感知体验</p>
</li>
<li>
<p>保证切换的一致性</p>
</li>
<li>
<p>提供可见性观察的目标对象</p>
</li>
</ul>
<p><a name="impauu"></a></p>
<h3><a href="#impauu"></a>如何提升切换时的体验？</h3>
<p>在真实组件开始渲染的时候，需要一定的时间和空间，时间指的是真实组件从创建到渲染的时间，包括请求接口、请求资源和渲染的时间，空间指的是页面布局中需要给真实组件留出刚好的位置，避免产生抖动。</p>
<p>这里我们可以使用 Vue.js 内置的 transition 组件自定义骨架组件和真实组件的进入和离开效果，通过合理的布局和定位，减少切换时的抖动，<br />通过设置过渡效果给真实组件留出一定的加载时间。</p>
<p>上面的问题都有了答案之后，我们很容易就可以实现一个通用的方案，来解决组件的懒加载问题。</p>
<p><a name="p40gng"></a></p>
<h2><a href="#p40gng"></a>Vue 组件懒加载方案介绍</h2>
<p>项目 Github 地址： <a href="https://github.com/xunleif2e/vue-lazy-component">https://github.com/xunleif2e/vue-lazy-component</a></p>
<p>这个是我们基于上面的思考做的一个通用的解决方案，下面简单介绍一下特性、使用以及 API 方面的知识，后面结合 5 个具体的 DEMO 来讲解更高级的用法。</p>
<p><a name="5gh3kk"></a></p>
<h2><a href="#5gh3kk"></a>特性</h2>
<ul>
<li>
<p>支持 组件可见或即将可见时懒加载</p>
</li>
<li>
<p>支持 组件延时加载</p>
</li>
<li>
<p>支持 加载组件前展示组件骨架，提高用户体验</p>
</li>
<li>
<p>支持 懒加载组件分包异步加载</p>
</li>
</ul>
<p><a name="btsppe"></a></p>
<h3><a href="#btsppe"></a>安装和使用</h3>
<pre><code class="language-bash">npm i @xunlei/vue-lazy-component
</code></pre>
<ul>
<li>
<p>方式 1 利用插件方式全局注册</p>
</li>
<li>
<p>方式 2 局部注册</p>
</li>
<li>
<p>方式 3 独立版本引入，自动全局注册</p>
</li>
</ul>
<p><a name="zt46ff"></a></p>
<h3><a href="#zt46ff"></a>用法</h3>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-4539c562e95dd997.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p><a name="rb3tfc"></a></p>
<h2><a href="#rb3tfc"></a>Props</h2>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>类型</th>
<th>可选值</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>viewport</td>
<td>组件所在的视口，如果组件是在页面容器内滚动，视口就是该容器</td>
<td>HTMLElement</td>
<td>true</td>
<td><code>null</code>
，代表视窗</td>
</tr>
<tr>
<td>direction</td>
<td>视口的滚动方向, 
<code>vertical</code>
代表垂直方向，
<code>horizontal</code>
代表水平方向</td>
<td>String</td>
<td>true</td>
<td><code>vertical</code></td>
</tr>
<tr>
<td>threshold</td>
<td>预加载阈值, css 单位</td>
<td>String</td>
<td>true</td>
<td><code>0px</code></td>
</tr>
<tr>
<td>tagName</td>
<td>包裹组件的外层容器的标签名</td>
<td>String</td>
<td>true</td>
<td><code>div</code></td>
</tr>
<tr>
<td>timeout</td>
<td>等待时间，如果指定了时间，不论可见与否，在指定时间之后自动加载</td>
<td>Number</td>
<td>true</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><a name="aylugf"></a></p>
<h2><a href="#aylugf"></a>Events</h2>
<table>
<thead>
<tr>
<th>事件名</th>
<th>说明</th>
<th>事件参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>before-init</td>
<td>模块可见或延时截止导致准备开始加载懒加载模块</td>
<td>-</td>
</tr>
<tr>
<td>init</td>
<td>开始加载懒加载模块，此时骨架组件开始消失</td>
<td>-</td>
</tr>
<tr>
<td>before-enter</td>
<td>懒加载模块开始进入</td>
<td>el</td>
</tr>
<tr>
<td>before-leave</td>
<td>骨架组件开始离开</td>
<td>el</td>
</tr>
<tr>
<td>after-leave</td>
<td>骨架组件已经离开</td>
<td>el</td>
</tr>
<tr>
<td>after-enter</td>
<td>懒加载模快已经进入</td>
<td>el</td>
</tr>
<tr>
<td>after-init</td>
<td>初始化完成</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><a name="s2arym"></a></p>
<h3><a href="#s2arym"></a>DEMO 1 超长页面懒加载</h3>
<p><a href="https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/large-page">https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/large-page</a></p>
<pre><code class="language-html">&#x3C;vue-lazy-component>
   &#x3C;st-series-sohu/>
   &#x3C;st-series-sohu-skeleton slot="skeleton"/>
&#x3C;/vue-lazy-component>
</code></pre>
<p>通过上面这种简单的使用方式就可以实现组件即将可见时自动加载。</p>
<p><a name="gf4uup"></a></p>
<h3><a href="#gf4uup"></a>DEMO 2 延时加载</h3>
<p><a href="https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/timeout">https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/timeout</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-99e60a730b55a64f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<pre><code>&#x3C;vue-lazy-component :timeout="1000">
    &#x3C;st-series-sohu/>
    &#x3C;st-series-sohu-skeleton slot="skeleton"/>
&#x3C;/vue-lazy-component>
</code></pre>
<p>如果有时候仅仅是希望某些组件稍后渲染，而不一定要等到可见时，可以通过这种方式。</p>
<p>比如我们业务中可能会有些运营性质的挂件，就可以采取延时加载的方式。</p>
<p><a name="vmlhiv"></a></p>
<h3><a href="#vmlhiv"></a>DEMO 3 自定义过渡效果</h3>
<p><a href="https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/custom-transition">https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/custom-transition</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-913aa9e8419d16b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>如果觉得 Vue Lazy Component 自带的淡入淡出的过渡效果太丑，或者需要调整淡入淡出效果的时长，就可以通过自定义样式来改变过渡效果。这个例子演示了另外一种过渡效果，transition 的生命周期可以参考 Vue.js 的 transition 组件的文档。</p>
<p><a name="cif6al"></a></p>
<h3><a href="#cif6al"></a>DEMO 4 webpack 分包</h3>
<p><a href="https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/large-page-chunks">https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/large-page-chunks</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-f104b5ec54a571da.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>DEMO1 演示了如何懒加载模块，但其实只是推迟了模块的渲染和模块内的资源的加载，如果我们需要更进一步，连模块本身的代码也是懒加载，就像 AMD 那样异步按需加载，这个也是可以做到的。</p>
<p>这里可以利用 Vue.js 的异步组件，将每个真实组件都注册成异步组件，在异步组件的工厂函数里使用 Webpack 的 AMD 版本的 require ，就可以实现真实组件可以分成独立的 bundle 加载，脱离页面 js 的 bundle。</p>
<p>但是这里会有个问题，就算模块是可见时才渲染，在打开页面的时候会发现模块不可见之前它的 bundle 已经加载了，这并没有实现按需加载。</p>
<p>这个例子演示了一种做法，Vue Lazy Component 可以在即将切换真实组件前通过 Scoped Slots 传递一个 loading 属性给真实组件，真实组件只要是根据这个 loading 来条件渲染就可以避免非按需加载，这个和 Vue.js 对组件的解析机制有关，例子里有相应的的代码，有兴趣的同学可以深入研究下。</p>
<p><a name="h29mwv"></a></p>
<h3><a href="#h29mwv"></a>DEMO 5 特定视口内懒加载</h3>
<p><a href="https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/specific-viewport">https://xunleif2e.github.io/vue-lazy-component/demo/dist/index.html#/specific-viewport</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-3a46b06943108220.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p>在某些场景下，我们要解决滚动容器内的组件懒加载，这个时候可见性是相对与这个视口来的，这个例子演示了如何指定聊天窗口作为观察的视口。</p>
<p>这里吐槽下 Vue.js 的 $parent 、$refs 的设计，它们都不是响应式的，如果需要动态获取这些组件引用上的 $el ，必须要等到 mounted 事件发生之后，所以例子的代码稍微有一点繁琐。</p>
<p><a name="rtb4qf"></a></p>
<h2><a href="#rtb4qf"></a>应用效果</h2>
<p>首先 Vue Lazy Component 的设计虽然是说组件级的，其实它的粒度可大可小，大的比如页面不同的区域，小的就像 DEMO5 里的只是一个用户头像，所以适用性非常强，只要有懒加载需求的场景基本都可以采用。</p>
<p>另外，在终端方面，不仅可以兼容 PC 端的项目，在移动端也是可以使用的，当然，需要解决 IntersectionObserver API 的兼容性问题，在项目 Readme 里提到了 w3c 的 polyfill 的地址。</p>
<p><a name="8h9coq"></a></p>
<h3><a href="#8h9coq"></a>应用业务</h3>
<p>我们目前应用在迅雷的两个项目中，一个是 PC 迅雷的首页项目，一个是 PC 迅雷的组队加速项目，后期预计会推广到更多的业务中去。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-ba9ace7a81847906.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p><a name="nhrkie"></a></p>
<h3><a href="#nhrkie"></a>优化后请求瀑布图</h3>
<p>我们再来看看开始那个页面的情况，在使用了 组件懒加载技术后，请求数变成了只有 31 个，瀑布图变得比较短了。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-b7ae7fcecc02294f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<p><a name="ez1naa"></a></p>
<h3><a href="#ez1naa"></a>数据对比</h3>
<p>我们把前后的数据进行一个对比：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/64173-7b8ff1f88bee06d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240#width="></p>
<ul>
<li>
<p>请求数变成之前的 1 / 5，优化效果比较明显</p>
</li>
<li>
<p>请求大小相比之前降低不太明显</p>
</li>
<li>
<p>load 时长也同样不太明显</p>
</li>
</ul>
<p>分析主要是有较多图片未按照使用尺寸裁剪和压缩，导致请求大小较大，同时造成了 load 时长的拖长。</p>
<p><a name="7puaoo"></a></p>
<h3><a href="#7puaoo"></a>后续性能优化方向</h3>
<p>后续我们会继续来优化这个页面，主要的方向有两个：</p>
<p><a name="5phukz"></a></p>
<h4><a href="#5phukz"></a>图片尺寸适配和压缩</h4>
<p>通过图片的裁剪和压缩，解决请求资源大小较大子资源加载时间较长导致 load 时间拖长的问题</p>
<p><a name="fgppgk"></a></p>
<h3><a href="#fgppgk"></a>预渲染</h3>
<p>采用预渲染插件将页面的主要 css 、js 进行内联，将骨架架屏通过预渲染生成出来，这样可以避免 SPA 首屏可见关键路径较长的问题，在页面解析完 dom 树以后即可保证首屏可见。</p>
<p><a name="tfgmpk"></a></p>
<h3><a href="#tfgmpk"></a>懒加载方案 ROADMAP</h3>
<p>Vue Lazy Component 懒加载方案还有些地方做得还不够好，计划在后期的几个小版本里支持以下的特性：</p>
<ul>
<li>
<p>SSR 支持 v1.1.0</p>
</li>
<li>
<p>UI 单元测试 v1.2.0</p>
</li>
<li>
<p>减少性能开销 v1.3.0</p>
<ul>
<li>
<p>重绘</p>
</li>
<li>
<p>FPS</p>
</li>
</ul>
</li>
</ul>
<p><a name="ygpklg"></a></p>
<h2><a href="#ygpklg"></a>后记</h2>
<p>这篇文章分享了从遇到业务实际性能问题，到分析、解决并梳理出通用的解决方案的过程，重点其实不是最终的实现代码实现，而是解决问题的角度和过程。</p>
<p>最后欢迎大家通过提交 issue 或者 PR 的方式参与贡献，项目 Github 地址： <a href="https://github.com/xunleif2e/vue-lazy-component">https://github.com/xunleif2e/vue-lazy-component</a> 。</p></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-6a6137d1e4f479833e32.js","107818501498521":"component---src-templates-blog-post-js-54ed0a12f5ff671a4ad0.js","212839066777427":"component---src-pages-blog-js-80ab4094666ff15e2c6b.js","35783957827783":"component---src-pages-index-js-ee4f1676e0bab5c0e3a4.js","60335399758886":"path----557518bd178906f8d58a.js","73070887314501":"path---blog-vue-lazy-component-63a3a39ab733be5d2f50.js","13655742387299":"path---blog-gitlab-ci-practice-210190ffe06905c3d0f8.js","218115079507401":"path---blog-vue-app-performance-enhance-guide-d77cdc0df32d2dbc552f.js","49683490770531":"path---blog-2ae392220dcde487d781.js","142629428675168":"path---index-d1f82ae4c9b540657035.js","114276838955818":"component---src-layouts-index-js-08ee7e55993cdf4c75cc.js"}/*]]>*/</script><script>/*<![CDATA[*/["/gatsby-contentful-starter/commons-ba4cb63d6a7a0250cd9f.js","/gatsby-contentful-starter/app-6a6137d1e4f479833e32.js","/gatsby-contentful-starter/path---blog-vue-lazy-component-63a3a39ab733be5d2f50.js","/gatsby-contentful-starter/component---src-templates-blog-post-js-54ed0a12f5ff671a4ad0.js","/gatsby-contentful-starter/component---src-layouts-index-js-08ee7e55993cdf4c75cc.js"].forEach(function(s){document.write('<script src="'+s+'" defer></'+'script>')})/*]]>*/</script></body></html>